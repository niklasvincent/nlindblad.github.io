user                          www-data;
pid                           /var/run/nginx.pid;
worker_processes              auto;
worker_priority               -5;
worker_rlimit_nofile          100000;

events {
    worker_connections        2048;
    multi_accept              on;
    use                       epoll;
}

http {
  disable_symlinks          if_not_owner;
  ## Start: Size Limits & Buffer Overflows ##
  client_body_buffer_size   1K;
  client_header_buffer_size 1k;
  client_max_body_size      1k;
  large_client_header_buffers 2 1k;
  ## END: Size Limits & Buffer Overflows ##
  limit_conn_zone           $binary_remote_addr zone=conn_limit_per_ip:10m;
  limit_req_zone            $binary_remote_addr zone=req_limit_per_ip:10m rate=5r/s;
  server_tokens             off;
  sendfile                  on;
  tcp_nopush                on;
  tcp_nodelay               on;
  ## OCSP stapling
  resolver                  8.8.8.8;
  ssl_stapling              on;
  ssl_trusted_certificate   ./server.crt;
  ssl_certificate           ./server.crt;
  ssl_certificate_key       ./server.key;
  ssl_dhparam               ./dhparam.pem;
  ssl_session_timeout       15m;
  ssl_protocols             TLSv1 TLSv1.1 TLSv1.2; # Do not use SSLv3 ref: POODLE
  ssl_ciphers               'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4';
  ssl_prefer_server_ciphers on;
  ssl_session_cache         shared:SSL:10m;

  add_header                Strict-Transport-Security "max-age=16070400; includeSubdomains";
  add_header                X-Frame-Options DENY;
  add_header                X-Content-Type-Options nosniff;
  add_header                X-XSS-Protection "1; mode=block";

  keepalive_timeout         20;
  client_header_timeout     20;
  client_body_timeout       20;
  reset_timedout_connection on;

  gzip                      on;
  gzip_static               always;
  gzip_proxied              any;
  gzip_min_length           256;
  gzip_comp_level           4;
  gzip_types                text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

  open_file_cache           max=65000 inactive=20s;
  open_file_cache_valid     30s;
  open_file_cache_min_uses  2;
  open_file_cache_errors    on;

  types {
    text/html                             html htm shtml;
    text/css                              css;
    text/xml                              xml rss;
    image/gif                             gif;
    image/jpeg                            jpeg jpg;
    application/x-javascript              js;
    text/plain                            txt;
    text/x-component                      htc;
    text/mathml                           mml;
    image/png                             png;
    image/x-icon                          ico;
    image/x-jng                           jng;
    image/vnd.wap.wbmp                    wbmp;
    application/java-archive              jar war ear;
    application/mac-binhex40              hqx;
    application/pdf                       pdf;
    application/x-cocoa                   cco;
    application/x-java-archive-diff       jardiff;
    application/x-java-jnlp-file          jnlp;
    application/x-makeself                run;
    application/x-perl                    pl pm;
    application/x-pilot                   prc pdb;
    application/x-rar-compressed          rar;
    application/x-redhat-package-manager  rpm;
    application/x-sea                     sea;
    application/x-shockwave-flash         swf;
    application/x-stuffit                 sit;
    application/x-tcl                     tcl tk;
    application/x-x509-ca-cert            der pem crt;
    application/x-xpinstall               xpi;
    application/zip                       zip;
    application/octet-stream              deb;
    application/octet-stream              bin exe dll;
    application/octet-stream              dmg;
    application/octet-stream              eot;
    application/octet-stream              iso img;
    application/octet-stream              msi msp msm;
    audio/mpeg                            mp3;
    audio/x-realaudio                     ra;
    video/mpeg                            mpeg mpg;
    video/quicktime                       mov;
    video/x-flv                           flv;
    video/x-msvideo                       avi;
    video/x-ms-wmv                        wmv;
    video/x-ms-asf                        asx asf;
    video/x-mng                           mng;
  }

  server {
    listen                443 default_server ssl spdy;
    server_name           niklaslindblad.se;
    access_log            off;
    access_log            /dev/null;
    error_log             /dev/null;
    root                  /var/www/niklaslindblad.se/public;
    autoindex		  on;
    limit_conn            conn_limit_per_ip 10;
    limit_req             zone=req_limit_per_ip burst=10 nodelay;
    disable_symlinks      off;
    if ($request_method !~ ^(GET|HEAD)$ ) {
      return 444;
    }
    location ~ \.css {
      add_header              Content-Type    text/css;
    }
    
    location ~ \.js {
      add_header              Content-Type    application/x-javascript;
    }

    location ~ \.pdf {
      add_header              Content-Type    application/pdf;
    }
  }

  server {
    add_header            Strict-Transport-Security "max-age=16070400; includeSubdomains";
    listen                80;
    server_name           niklaslindblad.se;
    rewrite               ^ https://$server_name$request_uri? permanent;
    access_log            off;
    access_log            /dev/null;
    error_log             /dev/null;
    root                  /var/www/niklaslindblad.se/public;
    limit_conn            conn_limit_per_ip 10;
    limit_req             zone=req_limit_per_ip burst=10 nodelay;
    if ($request_method !~ ^(GET|HEAD)$ ) {
      return 444;
    }
  }


}
